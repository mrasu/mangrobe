syntax = "proto3";

package mangrobe.api;
import "google/protobuf/timestamp.proto";

service DataManipulationService {
  rpc GetCurrentSnapshot(GetCurrentSnapshotRequest) returns (GetCurrentSnapshotResponse);

  rpc AddFiles(AddFilesRequest) returns (AddFilesResponse);
  rpc ChangeFiles(ChangeFilesRequest) returns (ChangeFilesResponse);
  rpc CompactFiles(CompactFilesRequest) returns (CompactFilesResponse);
}

service LockControlService {
  rpc AcquireFileLock(AcquireFileLockRequest) returns (AcquireFileLockResponse);
}

// IdempotencyKey must be unique across all methods
message IdempotencyKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

// FileLockKey must be unique across all methods
message FileLockKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

message GetCurrentSnapshotRequest {
  int64 table_id = 1;
  int64 stream_id = 2;
}

message GetCurrentSnapshotResponse {
  optional string commit_id = 1;

  repeated File files = 2;
}

message File {
  string path = 1;
  int64 size = 2;
}

message AddFilesRequest {
  IdempotencyKey idempotency_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;

  repeated AddFileEntry add_file_entries = 4;
}

message AddFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated AddFileInfoEntry file_info_entries = 2;
}

message AddFileInfoEntry {
  string path = 1;
  int64 size = 2;
}

message AddFilesResponse {
  string commit_id = 1;
}

message ChangeFilesRequest {
  FileLockKey file_lock_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;

  repeated ChangeFileEntry change_file_entries = 4;
}

message ChangeFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated ChangeFileDeleteEntry delete_entries = 2;
}

message ChangeFileDeleteEntry {
  string path = 1;
}

message ChangeFilesResponse {
  string commit_id = 1;
}

message CompactFilesRequest {
  FileLockKey file_lock_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;

  repeated CompactFileEntry compact_file_entries = 4;
}

message CompactFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated CompactFileInfoEntry file_info_entries = 2;
}

message CompactFileInfoEntry {
  repeated CompactFileSrcEntry src_entries = 1;
  CompactFileDstEntry dst_entry = 2;
}

message CompactFileSrcEntry {
  string path = 1;
}

message CompactFileDstEntry {
  string path = 1;
  int64 size = 2;
}

message CompactFilesResponse {
  string commit_id = 1;
}

message AcquireFileLockRequest {
  FileLockKey file_lock_key = 1;

  int64 table_id = 2;
  int64 stream_id = 3;

  int64 ttl_sec = 4;

  repeated AcquireFileLockEntry acquire_file_lock_entries =5;
}

message AcquireFileLockEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated AcquireFileLockFileInfoEntry acquire_file_info_entries =2;
}

message AcquireFileLockFileInfoEntry {
  string path = 1;
}

message AcquireFileLockResponse {
  repeated File files = 1;
}
