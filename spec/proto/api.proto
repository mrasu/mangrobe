syntax = "proto3";

package mangrobe.api;
import "google/protobuf/timestamp.proto";

service DataManipulationService {
  rpc GetCurrentSnapshot(GetCurrentSnapshotRequest) returns (GetCurrentSnapshotResponse);
  rpc GetCommits(GetCommitsRequest) returns (GetCommitsResponse);

  rpc AddFiles(AddFilesRequest) returns (AddFilesResponse);
  rpc ChangeFiles(ChangeFilesRequest) returns (ChangeFilesResponse);
  rpc CompactFiles(CompactFilesRequest) returns (CompactFilesResponse);
}

service LockControlService {
  rpc AcquireFileLock(AcquireFileLockRequest) returns (AcquireFileLockResponse);
  rpc ReleaseFileLock(ReleaseFileLockRequest) returns (ReleaseFileLockResponse);
}

service InformationSchemaService {
  rpc ListStreams(ListStreamsRequest) returns (ListStreamsResponse);
}

// IdempotencyKey must be unique across all methods
message IdempotencyKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

// FileLockKey must be unique across all methods
message FileLockKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

message GetCurrentSnapshotRequest {
  int64 table_id = 1;
  int64 stream_id = 2;
}

message GetCurrentSnapshotResponse {
  optional string commit_id = 1;

  repeated File files = 2;
}

message File {
  string path = 1;
  int64 size = 2;
}

message GetCommitsRequest {
  int64 table_id = 1;
  int64 stream_id = 2;

  // Optional. Starts at the beginning if not set.
  string commit_id_after = 3;
}

message GetCommitsResponse {
  int64 table_id = 1;
  int64 stream_id = 2;

  // Commits are ordered in the order they were applied.
  repeated Commit commits = 3;
}

message Commit {
  string commit_id = 1;

  oneof changes {
    AddedFiles added_files = 2;
    ChangedFiles changed_files = 3;
    CompactedFiles compacted_files = 4;
  }
}

message AddedFiles {
  repeated CommittedFile added_files = 1;
}

message ChangedFiles {
  repeated CommittedFile deleted_files = 1;
}

message CompactedFiles {
  repeated CompactedFile compacted_files = 1;
}

message CompactedFile {
  repeated CommittedFile src_files = 1;
  CommittedFile dst_file = 2;
}

message CommittedFile {
  string path = 1;
}

message AddFilesRequest {
  IdempotencyKey idempotency_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;

  repeated AddFileEntry add_file_entries = 4;
}

message AddFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated AddFileInfoEntry file_info_entries = 2;
}

message AddFileInfoEntry {
  string path = 1;
  int64 size = 2;
}

message AddFilesResponse {
  string commit_id = 1;
}

message ChangeFilesRequest {
  FileLockKey file_lock_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;

  repeated ChangeFileEntry change_file_entries = 4;
}

message ChangeFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated ChangeFileDeleteEntry delete_entries = 2;
}

message ChangeFileDeleteEntry {
  string path = 1;
}

message ChangeFilesResponse {
  string commit_id = 1;
}

message CompactFilesRequest {
  FileLockKey file_lock_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;

  repeated CompactFileEntry compact_file_entries = 4;
}

message CompactFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated CompactFileInfoEntry file_info_entries = 2;
}

message CompactFileInfoEntry {
  repeated CompactFileSrcEntry src_entries = 1;
  CompactFileDstEntry dst_entry = 2;
}

message CompactFileSrcEntry {
  string path = 1;
}

message CompactFileDstEntry {
  string path = 1;
  int64 size = 2;
}

message CompactFilesResponse {
  string commit_id = 1;
}

message AcquireFileLockRequest {
  FileLockKey file_lock_key = 1;

  int64 table_id = 2;
  int64 stream_id = 3;

  int64 ttl_sec = 4;

  repeated AcquireFileLockEntry acquire_file_lock_entries =5;
}

message AcquireFileLockEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated AcquireFileLockFileInfoEntry acquire_file_info_entries =2;
}

message AcquireFileLockFileInfoEntry {
  string path = 1;
}

message AcquireFileLockResponse {
  repeated File files = 1;
}

message ReleaseFileLockRequest {
  FileLockKey file_lock_key = 1;
}

message ReleaseFileLockResponse {
  bool deleted = 1;
}

message ListStreamsRequest {
  PaginationRequest pagination = 1;

  int64 table_id = 2;
}

message ListStreamsResponse {
  PaginationResponse pagination = 1;

  int64 table_id = 2;
  repeated StreamInfo streams = 3;
}

message StreamInfo {
  int64 stream_id = 1;
  string last_commit_id = 2;
}

message PaginationRequest  {
  // Must be positive. If zero, the system chooses an appropriate default. If too large, the system coerces down to an acceptable size.
  int32 size = 1;
  // Optional. Starts at the beginning if not set.
  string token = 2;
}

message PaginationResponse {
  string next_token = 1;
}
