syntax = "proto3";

package mangrobe.api;
import "google/protobuf/timestamp.proto";

service DataManipulationService {
  rpc GetCurrentState(GetCurrentStateRequest) returns (GetCurrentStateResponse);
  rpc GetCommits(GetCommitsRequest) returns (GetCommitsResponse);
  rpc GetFileInfo(GetFileInfoRequest) returns (GetFileInfoResponse);

  rpc AddFiles(AddFilesRequest) returns (AddFilesResponse);
  rpc ChangeFiles(ChangeFilesRequest) returns (ChangeFilesResponse);
  rpc CompactFiles(CompactFilesRequest) returns (CompactFilesResponse);
}

service DataDefinitionService {
  rpc CreateTable(CreateTableRequest) returns (CreateTableResponse);
}

service LockControlService {
  rpc AcquireFileLock(AcquireFileLockRequest) returns (AcquireFileLockResponse);
  rpc ReleaseFileLock(ReleaseFileLockRequest) returns (ReleaseFileLockResponse);
}

service InformationSchemaService {
  rpc ListStreams(ListStreamsRequest) returns (ListStreamsResponse);
}

// IdempotencyKey must be unique across all methods
message IdempotencyKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

// FileLockKey must be unique across all methods
message FileLockKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

message GetCurrentStateRequest {
  string table_name = 1;
  int64 stream_id = 2;
}

message GetCurrentStateResponse {
  optional string commit_id = 1;

  repeated File files = 2;
}

message File {
  string file_id = 1;
  string path = 2;
  int64 size = 3;

  // TODO: return stats' and metadata enum
}

message GetCommitsRequest {
  string table_name = 1;
  int64 stream_id = 2;

  // Optional. Starts at the beginning if not set.
  optional string commit_id_after = 3;
}

message GetCommitsResponse {
  string table_name = 1;
  int64 stream_id = 2;

  // Commits are ordered in the order they were applied.
  repeated Commit commits = 3;
}

message Commit {
  string commit_id = 1;

  oneof changes {
    AddedFiles added_files = 2;
    ChangedFiles changed_files = 3;
    CompactedFiles compacted_files = 4;
  }
}

message AddedFiles {
  repeated CommittedFile added_files = 1;
}

message ChangedFiles {
  repeated CommittedFile deleted_files = 1;
}

message CompactedFiles {
  repeated CompactedFile compacted_files = 1;
}

message CompactedFile {
  repeated CommittedFile src_files = 1;
  CommittedFile dst_file = 2;
}

message CommittedFile {
  string file_id = 1;
  string path = 2;
}

message GetFileInfoRequest {
  repeated string file_ids = 1;
  repeated FileColumnStatisticsType included_column_statistics_types = 2;
  repeated FileMetadataType included_file_metadata_types = 3;
}

enum FileColumnStatisticsType {
  // Unspecified. Invalid value.
  FILE_COLUMN_STATISTICS_TYPE_UNSPECIFIED = 0;

  FILE_COLUMN_STATISTICS_TYPE_MIN = 1;
  FILE_COLUMN_STATISTICS_TYPE_MAX = 2;
}

enum FileMetadataType {
  // Unspecified. Invalid value.
  FILE_METADATA_TYPE_UNSPECIFIED = 0;

  FILE_METADATA_TYPE_PARQUET_METADATA = 1;
}

message GetFileInfoResponse {
  repeated FileInfoResponse file_info = 1;
}

message FileInfoResponse {
  string file_id = 1;
  string path = 2;
  int64 size = 3;
  repeated FileColumnStatistics column_statistics = 4;
  FileMetadata file_metadata = 5;
}

message FileColumnStatistics {
  string column_name = 1;
  optional double min = 2;
  optional double max = 3;
}

message FileMetadata {
  optional bytes parquet_metadata = 1;
}

message AddFilesRequest {
  IdempotencyKey idempotency_key = 1;
  string table_name = 2;
  int64 stream_id = 3;

  repeated AddFileEntry add_file_entries = 4;
}

message AddFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated AddFileInfoEntry file_info_entries = 2;
}

message AddFileInfoEntry {
  string path = 1;
  int64 size = 2;

  repeated ColumnStatisticsEntry column_statistics = 3;
  FileMetadataEntry file_metadata = 4;
}

message ColumnStatisticsEntry {
  string column_name = 1;
  optional double min = 2;
  optional double max = 3;
}

message FileMetadataEntry {
  // parquet_metadata is for Parquet metadata (FileMetaData defined in https://github.com/apache/parquet-format).
  // No footer length or magic bytes.
  optional bytes parquet_metadata = 1;
}

message AddFilesResponse {
  string commit_id = 1;
}

message ChangeFilesRequest {
  FileLockKey file_lock_key = 1;
  string table_name = 2;
  int64 stream_id = 3;

  repeated ChangeFileEntry change_file_entries = 4;
}

message ChangeFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated ChangeFileDeleteEntry delete_entries = 2;
}

message ChangeFileDeleteEntry {
  string path = 1;
}

message ChangeFilesResponse {
  string commit_id = 1;
}

message CompactFilesRequest {
  FileLockKey file_lock_key = 1;
  string table_name = 2;
  int64 stream_id = 3;

  repeated CompactFileEntry compact_file_entries = 4;
}

message CompactFileEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated CompactFileInfoEntry file_info_entries = 2;
}

message CompactFileInfoEntry {
  repeated CompactFileSrcEntry src_entries = 1;
  CompactFileDstEntry dst_entry = 2;
}

message CompactFileSrcEntry {
  string path = 1;
}

message CompactFileDstEntry {
  string path = 1;
  int64 size = 2;

  repeated ColumnStatisticsEntry column_statistics = 3;
  FileMetadataEntry file_metadata = 4;
}

message CompactFilesResponse {
  string commit_id = 1;
}

message CreateTableRequest {
  string table_name = 1;
  bool skip_if_exists = 2;
}

message CreateTableResponse {
  string table_name = 1;
}

message AcquireFileLockRequest {
  FileLockKey file_lock_key = 1;

  string table_name = 2;
  int64 stream_id = 3;

  int64 ttl_sec = 4;

  repeated AcquireFileLockEntry acquire_file_lock_entries =5;
}

message AcquireFileLockEntry {
  google.protobuf.Timestamp partition_time = 1;

  repeated AcquireFileLockFileInfoEntry acquire_file_info_entries =2;
}

message AcquireFileLockFileInfoEntry {
  string path = 1;
}

message AcquireFileLockResponse {
  repeated File files = 1;
}

message ReleaseFileLockRequest {
  FileLockKey file_lock_key = 1;
}

message ReleaseFileLockResponse {
  bool deleted = 1;
}

message ListStreamsRequest {
  PaginationRequest pagination = 1;

  string table_name = 2;
}

message ListStreamsResponse {
  PaginationResponse pagination = 1;

  string table_name = 2;
  repeated StreamInfo streams = 3;
}

message StreamInfo {
  int64 stream_id = 1;
  string last_commit_id = 2;
}

message PaginationRequest  {
  // Must be positive. If zero, the system chooses an appropriate default. If too large, the system coerces down to an acceptable size.
  int32 size = 1;
  // Optional. Starts at the beginning if not set.
  optional string token = 2;
}

message PaginationResponse {
  string next_token = 1;
}
