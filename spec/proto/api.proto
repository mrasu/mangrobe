syntax = "proto3";

package mangrobe.api;
import "google/protobuf/timestamp.proto";

service DataManipulationService {
  rpc GetCurrentSnapshot(GetCurrentSnapshotRequest) returns (GetCurrentSnapshotResponse);

  rpc AddFiles(AddFilesRequest) returns (AddFilesResponse);
  rpc ChangeFiles(ChangeFilesRequest) returns (ChangeFilesResponse);
  rpc CompactFiles(CompactFilesRequest) returns (CompactFilesResponse);
}

service LockControlService {
  rpc AcquireFileLock(AcquireFileLockRequest) returns (AcquireFileLockResponse);
}

// IdempotencyKey must be unique across all methods
message IdempotencyKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

// FileLockKey must be unique across all methods
message FileLockKey {
  // Must be shorter than 16 byte
  bytes key = 1;
}

message GetCurrentSnapshotRequest {
  int64 table_id = 1;
  int64 stream_id = 2;
}

message GetCurrentSnapshotResponse {
  optional string commit_id = 1;

  repeated File files = 2;
}

message File {
  string path = 1;
  int64 size = 2;
}

message AddFilesRequest {
  IdempotencyKey idempotency_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;
  google.protobuf.Timestamp partition_time = 4;
  repeated FileAddEntry file_add_entries = 5;
}

message FileAddEntry {
  string path = 1;
  int64 size = 2;
}

message AddFilesResponse {
  string commit_id = 1;
}

message ChangeFilesRequest {
  FileLockKey file_lock_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;
  google.protobuf.Timestamp partition_time = 4;

  repeated FileDeleteEntry file_delete_entries = 5;
}

message FileDeleteEntry {
  string path = 1;
}

message ChangeFilesResponse {
  string commit_id = 1;
}

message CompactFilesRequest {
  FileLockKey file_lock_key = 1;
  int64 table_id = 2;
  int64 stream_id = 3;
  google.protobuf.Timestamp partition_time = 4;

  repeated FileCompactSrcEntry src_file_entries = 5;
  FileCompactDstEntry dst_file_entry = 6;
}

message FileCompactSrcEntry {
  string path = 1;
}

message FileCompactDstEntry {
  string path = 1;
  int64 size = 2;
}

message CompactFilesResponse {
  string commit_id = 1;
}

message AcquireFileLockRequest {
  FileLockKey file_lock_key = 1;

  int64 table_id = 2;
  int64 stream_id = 3;
  google.protobuf.Timestamp partition_time = 4;

  int64 ttl_sec = 5;

  repeated LockFile target_files =6;
}

message LockFile {
  string path = 1;
}

message AcquireFileLockResponse {
  repeated File files = 1;
}
